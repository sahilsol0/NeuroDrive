{% extends "dashboard/base.html" %}
{% load i18n %}

{% block dashboard_title %}{% trans "Submit Review" %}{% endblock dashboard_title %}

{% block dashboard_content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-2xl mx-auto bg-white shadow-md rounded-lg overflow-hidden">
        <div class="p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">{% trans "Submit Review" %}</h2>
            
            <!-- Show the form only to passengers -->
            {% if ride.passenger == request.user %}
                <p class="mb-4">{% trans "Please provide your feedback for the ride." %}</p>
                
                <form method="post" class="space-y-6">
                    {% csrf_token %}
                    
                    <!-- Star Rating System -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            {% trans "Rate your experience" %}
                        </label>
                        <div class="star-rating flex items-center gap-1">
                            <input type="radio" id="star1" name="driver_rating" value="1" class="sr-only" required>
                            <input type="radio" id="star2" name="driver_rating" value="2" class="sr-only">
                            <input type="radio" id="star3" name="driver_rating" value="3" class="sr-only">
                            <input type="radio" id="star4" name="driver_rating" value="4" class="sr-only">
                            <input type="radio" id="star5" name="driver_rating" value="5" class="sr-only">
                            
                            <div class="flex">
                                <label for="star1" class="star-label cursor-pointer text-4xl" title="1 star">
                                    <svg class="w-8 h-8 star-icon text-gray-300" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M20.924 7.625a1.523 1.523 0 0 0-1.238-1.044l-5.051-.734-2.259-4.577a1.534 1.534 0 0 0-2.752 0L7.365 5.847l-5.051.734A1.535 1.535 0 0 0 1.463 9.2l3.656 3.563-.863 5.031a1.532 1.532 0 0 0 2.226 1.616L11 17.033l4.518 2.375a1.534 1.534 0 0 0 2.226-1.617l-.863-5.03L20.537 9.2a1.523 1.523 0 0 0 .387-1.575Z"/>
                                    </svg>
                                </label>
                                <label for="star2" class="star-label cursor-pointer text-4xl" title="2 stars">
                                    <svg class="w-8 h-8 star-icon text-gray-300" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M20.924 7.625a1.523 1.523 0 0 0-1.238-1.044l-5.051-.734-2.259-4.577a1.534 1.534 0 0 0-2.752 0L7.365 5.847l-5.051.734A1.535 1.535 0 0 0 1.463 9.2l3.656 3.563-.863 5.031a1.532 1.532 0 0 0 2.226 1.616L11 17.033l4.518 2.375a1.534 1.534 0 0 0 2.226-1.617l-.863-5.03L20.537 9.2a1.523 1.523 0 0 0 .387-1.575Z"/>
                                    </svg>
                                </label>
                                <label for="star3" class="star-label cursor-pointer text-4xl" title="3 stars">
                                    <svg class="w-8 h-8 star-icon text-gray-300" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M20.924 7.625a1.523 1.523 0 0 0-1.238-1.044l-5.051-.734-2.259-4.577a1.534 1.534 0 0 0-2.752 0L7.365 5.847l-5.051.734A1.535 1.535 0 0 0 1.463 9.2l3.656 3.563-.863 5.031a1.532 1.532 0 0 0 2.226 1.616L11 17.033l4.518 2.375a1.534 1.534 0 0 0 2.226-1.617l-.863-5.03L20.537 9.2a1.523 1.523 0 0 0 .387-1.575Z"/>
                                    </svg>
                                </label>
                                <label for="star4" class="star-label cursor-pointer text-4xl" title="4 stars">
                                    <svg class="w-8 h-8 star-icon text-gray-300" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M20.924 7.625a1.523 1.523 0 0 0-1.238-1.044l-5.051-.734-2.259-4.577a1.534 1.534 0 0 0-2.752 0L7.365 5.847l-5.051.734A1.535 1.535 0 0 0 1.463 9.2l3.656 3.563-.863 5.031a1.532 1.532 0 0 0 2.226 1.616L11 17.033l4.518 2.375a1.534 1.534 0 0 0 2.226-1.617l-.863-5.03L20.537 9.2a1.523 1.523 0 0 0 .387-1.575Z"/>
                                    </svg>
                                </label>
                                <label for="star5" class="star-label cursor-pointer text-4xl" title="5 stars">
                                    <svg class="w-8 h-8 star-icon text-gray-300" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M20.924 7.625a1.523 1.523 0 0 0-1.238-1.044l-5.051-.734-2.259-4.577a1.534 1.534 0 0 0-2.752 0L7.365 5.847l-5.051.734A1.535 1.535 0 0 0 1.463 9.2l3.656 3.563-.863 5.031a1.532 1.532 0 0 0 2.226 1.616L11 17.033l4.518 2.375a1.534 1.534 0 0 0 2.226-1.617l-.863-5.03L20.537 9.2a1.523 1.523 0 0 0 .387-1.575Z"/>
                                    </svg>
                                </label>
                            </div>
                            <div id="rating-text" class="ml-3 text-lg font-medium text-gray-700">Not rated</div>
                        </div>
                        <p id="rating-error" class="mt-2 text-sm text-red-600 hidden">
                            {% trans "Please select a rating." %}
                        </p>
                    </div>

                    <!-- Passenger Comment -->
                    <div>
                        <label for="passenger_comment" class="block text-sm font-medium text-gray-700 mb-2">
                            {% trans "Comments (optional)" %}
                        </label>
                        <textarea id="passenger_comment" name="passenger_comment" rows="4"
                                  class="mt-1 p-2 block w-full border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                  placeholder="{% trans 'Share your experience...' %}"></textarea>
                    </div>

                    <!-- Form Actions -->
                    <div class="flex justify-between space-x-4">
                        <a href="{% url 'ride_status' ride.id %}" class="flex items-center gap-2 px-4 py-3 text-gray-700 hover:bg-gray-100 hover:text-gray-700 rounded-xl">
                            <i data-lucide="arrow-left" class="w-5 h-5"></i>
                            {% trans "Go Back" %}
                        </a>
                        <button type="submit" class="flex items-center gap-2 px-4 py-3 text-blue-700 bg-blue-100 hover:bg-blue-200 hover:text-blue-700 rounded-xl">
                            {% trans "Submit Rating" %}
                        </button>
                    </div>
                </form>
            {% else %}
                <!-- Show a message if the user is not the passenger -->
                <p class="text-gray-700">{% trans "Only the passenger can submit a review for this ride." %}</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- JavaScript for Star Rating -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const starLabels = document.querySelectorAll('.star-label');
        const starIcons = document.querySelectorAll('.star-icon');
        const ratingInputs = document.querySelectorAll('input[name="driver_rating"]');
        const ratingText = document.getElementById('rating-text');
        const ratingError = document.getElementById('rating-error');
        const ratingTexts = ["Not rated", "Poor", "Fair", "Good", "Very Good", "Excellent"];
        let currentRating = 0;
        
        // Initialize any existing rating (if editing)
        function initializeRating() {
            for (let i = 0; i < ratingInputs.length; i++) {
                if (ratingInputs[i].checked) {
                    currentRating = parseInt(ratingInputs[i].value);
                    break;
                }
            }
            updateStars();
        }
        
        // Update stars based on currentRating
        function updateStars() {
            starIcons.forEach((star, index) => {
                if (index < currentRating) {
                    star.classList.remove('text-gray-300');
                    star.classList.add('text-primary');
                } else {
                    star.classList.remove('text-primary');
                    star.classList.add('text-gray-300');
                }
            });
            
            ratingText.textContent = ratingTexts[currentRating];
        }
        
        // Handle hover effects
        starLabels.forEach((label, index) => {
            label.addEventListener('mouseenter', () => {
                const hoverRating = index + 1;
                
                starIcons.forEach((star, starIndex) => {
                    if (starIndex <= index) {
                        star.classList.remove('text-gray-300');
                        star.classList.add('text-primary');
                    } else {
                        star.classList.remove('text-primary');
                        star.classList.add('text-gray-300');
                    }
                });
                
                ratingText.textContent = ratingTexts[hoverRating];
            });
            
            label.addEventListener('mouseleave', () => {
                updateStars();
            });
            
            // Handle click
            label.addEventListener('click', () => {
                currentRating = index + 1;
                ratingInputs[index].checked = true;
                updateStars();
                ratingError.classList.add('hidden');
            });
        });
        
        // Validate on form submission
        const form = document.querySelector('form');
        form.addEventListener('submit', function(e) {
            if (currentRating === 0) {
                e.preventDefault();
                ratingError.classList.remove('hidden');
            }
        });
        
        // Initialize
        initializeRating();
    });
</script>
{% endblock dashboard_content %}