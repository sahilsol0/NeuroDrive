{% extends "base.html" %}
{% load static %}
{% load i18n %}
{% load custom_filters %}

{% block title %}{% trans "Dashboard" %} | {% block dashboard_title %}{% endblock dashboard_title %}{% endblock title %}
{% block nav %}
<header class="fixed w-screen z-50 flex justify-between items-center pl-4 pr-12 lg:pl-6 lg:pr-24 py-4 lg:py-6 bg-background text-md md:text-lg">
    <a class="" href="{% url 'landing' %}"><svg class="w-32" viewBox="0 0 141 32" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M7.31818 21.0455V31H1.76136V13.5455H7.04545V16.75H7.23864C7.625 15.6818 8.28409 14.8447 9.21591 14.2386C10.1477 13.625 11.2576 13.3182 12.5455 13.3182C13.7727 13.3182 14.8371 13.5947 15.7386 14.1477C16.6477 14.6932 17.3523 15.4583 17.8523 16.4432C18.3598 17.4205 18.6098 18.5644 18.6023 19.875V31H13.0455V20.9659C13.053 19.9962 12.8068 19.2386 12.3068 18.6932C11.8144 18.1477 11.1288 17.875 10.25 17.875C9.66667 17.875 9.15152 18.0038 8.70455 18.2614C8.26515 18.5114 7.92424 18.8712 7.68182 19.3409C7.44697 19.8106 7.32576 20.3788 7.31818 21.0455ZM27.3217 31.3295C25.4959 31.3295 23.9202 30.9697 22.5944 30.25C21.2762 29.5227 20.2611 28.4886 19.549 27.1477C18.8444 25.7992 18.4922 24.197 18.4922 22.3409C18.4922 20.5379 18.8482 18.9621 19.5603 17.6136C20.2725 16.2576 21.2762 15.2045 22.5717 14.4545C23.8672 13.697 25.3937 13.3182 27.1512 13.3182C28.3937 13.3182 29.53 13.5114 30.5603 13.8977C31.5906 14.2841 32.4808 14.8561 33.2308 15.6136C33.9808 16.3712 34.5641 17.3068 34.9808 18.4205C35.3975 19.5265 35.6058 20.7955 35.6058 22.2273V23.6136H20.4353V20.3864H30.4353C30.4278 19.7955 30.2876 19.2689 30.0149 18.8068C29.7422 18.3447 29.3672 17.9848 28.8899 17.7273C28.4202 17.4621 27.8785 17.3295 27.2649 17.3295C26.6437 17.3295 26.0869 17.4697 25.5944 17.75C25.102 18.0227 24.7119 18.3977 24.424 18.875C24.1361 19.3447 23.9846 19.8788 23.9694 20.4773V23.7614C23.9694 24.4735 24.1096 25.0985 24.3899 25.6364C24.6702 26.1667 25.0679 26.5795 25.5831 26.875C26.0982 27.1705 26.7119 27.3182 27.424 27.3182C27.9164 27.3182 28.3634 27.25 28.7649 27.1136C29.1664 26.9773 29.5111 26.7765 29.799 26.5114C30.0869 26.2462 30.3028 25.9205 30.4467 25.5341L35.549 25.6818C35.3369 26.8258 34.8709 27.822 34.1512 28.6705C33.4391 29.5114 32.5035 30.1667 31.3444 30.6364C30.1853 31.0985 28.8444 31.3295 27.3217 31.3295ZM46.8252 23.4659V13.5455H52.3707V31H47.0752V27.75H46.8934C46.507 28.8182 45.848 29.6667 44.9161 30.2955C43.9919 30.9167 42.8745 31.2273 41.5639 31.2273C40.3745 31.2273 39.329 30.9545 38.4275 30.4091C37.526 29.8636 36.8252 29.1023 36.3252 28.125C35.8252 27.1402 35.5714 25.9886 35.5639 24.6705V13.5455H41.1207V23.5795C41.1283 24.5265 41.3783 25.2727 41.8707 25.8182C42.3631 26.3636 43.0336 26.6364 43.882 26.6364C44.4351 26.6364 44.9313 26.5152 45.3707 26.2727C45.8176 26.0227 46.1699 25.6629 46.4275 25.1932C46.6926 24.7159 46.8252 24.1402 46.8252 23.4659ZM53.0276 31V13.5455H58.4253V16.7273H58.6072C58.9253 15.5758 59.4443 14.7197 60.164 14.1591C60.8837 13.5909 61.7208 13.3068 62.6753 13.3068C62.9329 13.3068 63.1981 13.3258 63.4708 13.3636C63.7435 13.3939 63.9973 13.4432 64.2322 13.5114V18.3409C63.967 18.25 63.6185 18.178 63.1867 18.125C62.7625 18.072 62.3837 18.0455 62.0503 18.0455C61.3913 18.0455 60.7966 18.1932 60.2663 18.4886C59.7435 18.7765 59.3306 19.1818 59.0276 19.7045C58.7322 20.2197 58.5844 20.8258 58.5844 21.5227V31H53.0276ZM70.8578 31.3295C69.0245 31.3295 67.4487 30.9545 66.1306 30.2045C64.82 29.447 63.8086 28.3939 63.0965 27.0455C62.3919 25.6894 62.0397 24.1174 62.0397 22.3295C62.0397 20.5341 62.3919 18.9621 63.0965 17.6136C63.8086 16.2576 64.82 15.2045 66.1306 14.4545C67.4487 13.697 69.0245 13.3182 70.8578 13.3182C72.6912 13.3182 74.2631 13.697 75.5737 14.4545C76.8919 15.2045 77.9033 16.2576 78.6078 17.6136C79.32 18.9621 79.676 20.5341 79.676 22.3295C79.676 24.1174 79.32 25.6894 78.6078 27.0455C77.9033 28.3939 76.8919 29.447 75.5737 30.2045C74.2631 30.9545 72.6912 31.3295 70.8578 31.3295ZM70.8919 27.1364C71.5586 27.1364 72.123 26.9318 72.5851 26.5227C73.0472 26.1136 73.3995 25.5455 73.6419 24.8182C73.8919 24.0909 74.0169 23.25 74.0169 22.2955C74.0169 21.3258 73.8919 20.4773 73.6419 19.75C73.3995 19.0227 73.0472 18.4545 72.5851 18.0455C72.123 17.6364 71.5586 17.4318 70.8919 17.4318C70.2025 17.4318 69.6192 17.6364 69.1419 18.0455C68.6722 18.4545 68.3124 19.0227 68.0624 19.75C67.82 20.4773 67.6987 21.3258 67.6987 22.2955C67.6987 23.25 67.82 24.0909 68.0624 24.8182C68.3124 25.5455 68.6722 26.1136 69.1419 26.5227C69.6192 26.9318 70.2025 27.1364 70.8919 27.1364Z" fill="black"/>
        <path d="M88.8636 31.3636C87.4621 31.3636 86.2386 30.9773 85.1932 30.2045C84.1477 29.4318 83.3371 28.3674 82.7614 27.0114C82.1932 25.6477 81.9091 24.0833 81.9091 22.3182C81.9091 20.5682 82.197 19.0152 82.7727 17.6591C83.3561 16.2955 84.1705 15.2273 85.2159 14.4545C86.2614 13.6742 87.4811 13.2841 88.875 13.2841C89.875 13.2841 90.7424 13.4773 91.4773 13.8636C92.2197 14.2424 92.8409 14.7462 93.3409 15.375C93.8485 16.0038 94.2348 16.6932 94.5 17.4432H94.6364V7.72727H96.0114V31H94.6705V27.1932H94.5C94.2197 27.9432 93.8295 28.6364 93.3295 29.2727C92.8295 29.9015 92.2083 30.4091 91.4659 30.7955C90.7235 31.1742 89.8561 31.3636 88.8636 31.3636ZM88.9886 30.0795C90.1705 30.0795 91.1818 29.7424 92.0227 29.0682C92.8712 28.3864 93.5189 27.4621 93.9659 26.2955C94.4205 25.1212 94.6477 23.7917 94.6477 22.3068C94.6477 20.822 94.4205 19.5 93.9659 18.3409C93.5189 17.1742 92.8712 16.2576 92.0227 15.5909C91.1818 14.9167 90.1705 14.5795 88.9886 14.5795C87.7917 14.5795 86.7652 14.9205 85.9091 15.6023C85.0606 16.2765 84.4091 17.197 83.9545 18.3636C83.5076 19.5303 83.2841 20.8447 83.2841 22.3068C83.2841 23.7689 83.5076 25.0871 83.9545 26.2614C84.4091 27.4356 85.0606 28.3674 85.9091 29.0568C86.7652 29.7386 87.7917 30.0795 88.9886 30.0795ZM99.37 31V13.5455H100.722V16.2727H100.847C101.226 15.3788 101.866 14.6629 102.768 14.125C103.669 13.5795 104.696 13.3068 105.847 13.3068C105.968 13.3068 106.09 13.3068 106.211 13.3068C106.332 13.3068 106.446 13.3106 106.552 13.3182V14.7159C106.461 14.7083 106.351 14.697 106.222 14.6818C106.101 14.6591 105.95 14.6477 105.768 14.6477C104.798 14.6477 103.934 14.8561 103.177 15.2727C102.427 15.6894 101.836 16.2652 101.404 17C100.972 17.7273 100.756 18.5606 100.756 19.5V31H99.37ZM107.464 31V13.5455H108.839V31H107.464ZM108.158 10.4545C107.855 10.4545 107.589 10.3485 107.362 10.1364C107.142 9.92424 107.033 9.66667 107.033 9.36364C107.033 9.06061 107.142 8.80303 107.362 8.59091C107.582 8.37879 107.847 8.27273 108.158 8.27273C108.461 8.27273 108.722 8.37879 108.942 8.59091C109.169 8.80303 109.283 9.06061 109.283 9.36364C109.283 9.66667 109.173 9.92424 108.953 10.1364C108.733 10.3485 108.468 10.4545 108.158 10.4545ZM124.528 13.5455L118.221 31H116.653L110.346 13.5455H111.834L117.38 29.2159H117.494L123.039 13.5455H124.528ZM132.162 31.3636C130.586 31.3636 129.215 30.9735 128.048 30.1932C126.882 29.4129 125.98 28.3447 125.344 26.9886C124.707 25.6326 124.389 24.0871 124.389 22.3523C124.389 20.6098 124.707 19.0568 125.344 17.6932C125.988 16.3295 126.87 15.2538 127.991 14.4659C129.113 13.678 130.393 13.2841 131.832 13.2841C132.81 13.2841 133.734 13.4811 134.605 13.875C135.484 14.2614 136.257 14.822 136.923 15.5568C137.597 16.2917 138.124 17.178 138.503 18.2159C138.889 19.2538 139.082 20.4205 139.082 21.7159V22.5795H125.264V21.3182H137.696C137.696 20.053 137.438 18.9129 136.923 17.8977C136.408 16.8826 135.707 16.0758 134.821 15.4773C133.935 14.8788 132.938 14.5795 131.832 14.5795C130.673 14.5795 129.639 14.9053 128.73 15.5568C127.828 16.2008 127.113 17.072 126.582 18.1705C126.06 19.2689 125.787 20.4962 125.764 21.8523V22.4205C125.764 23.875 126.018 25.1818 126.525 26.3409C127.041 27.4924 127.775 28.4053 128.73 29.0795C129.685 29.7462 130.828 30.0795 132.162 30.0795C133.116 30.0795 133.931 29.9205 134.605 29.6023C135.287 29.2765 135.844 28.8826 136.275 28.4205C136.707 27.9583 137.033 27.5114 137.253 27.0795L138.514 27.5909C138.249 28.1742 137.836 28.7576 137.275 29.3409C136.722 29.9167 136.018 30.3977 135.162 30.7841C134.313 31.1705 133.313 31.3636 132.162 31.3636Z" fill="black"/>
    </svg></a>
    <nav class="">
        {% if user.is_superuser %} {% trans "For Managers" %}
        {% elif user.is_driver %} {% trans "For Drivers" %}
        {% else %} {% trans "For Passengers" %}
        {% endif %}
    </nav>
</header>
{% endblock nav %}

{% block content %}
<div class="h-16 md:h-20"></div>
<div class="flex flex-col h-screen bg-gray-100">
	<!-- Mobile Header -->
    <header class="lg:hidden bg-white">
        <div class="flex items-center justify-between px-4 py-4">
            <div class="relative">
                <button id="mobile-profile-button" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="user" class="w-6 h-6"></i>
                </button>
            </div>
            <span class="text-lg font-semibold">
                <a href="{% url "home" %}" class="pointer">{% trans "Dashboard" %}</a> 
                <span class="font-normal">| {{ request.resolver_match.url_name|humanize_url_name }}</span>
            </span>
            <button id="mobile-menu-button" class="text-gray-500 hover:text-gray-700">
                <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
        </div>
    </header>                      

    <!-- Mobile Profile Dialog -->
    <div id="mobile-profile-dialog" class="fixed inset-0 z-50 lg:hidden hidden">
        <div class="fixed inset-0 bg-gray-600 bg-opacity-75"></div>
        <div class="fixed inset-x-0 top-1/3 mx-4">
            <div class="bg-white rounded-lg shadow-xl">
                <div class="p-4">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-lg font-medium text-gray-900">{% trans "Profile" %}</h3>
                        <button id="close-profile-dialog" class="text-gray-500 hover:text-gray-700">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div class="space-y-3">
                        <div class="flex items-center space-x-3">
                            <i data-lucide="mail" class="w-5 h-5 text-gray-400"></i>
                            <span class="text-sm text-gray-600">{{ user.email }}</span>
                        </div>
                        <a href="{% url 'account_change_password' %}" 
                           class="flex items-center space-x-3 text-gray-400 hover:text-gray-700">
                            <i data-lucide="rectangle-ellipsis" class="w-5 h-5"></i>
                            <span>{% trans "Change Password" %}</span>
                        </a>
                        <a href="{% url 'account_logout' %}" 
                           class="flex items-center space-x-3 text-red-400 hover:text-red-700">
                            <i data-lucide="log-out" class="w-5 h-5"></i>
                            <span>{% trans "Logout" %}</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Sidebar (Hidden by default) -->
    <div id="mobile-sidebar" class="fixed inset-0 z-40 lg:hidden hidden">
        <div class="fixed w-full inset-0 bg-gray-600 bg-opacity-75"></div>
        <nav class="relative flex flex-col w-5/6 max-w-sm h-full bg-white pt-20">
            <div class="p-4 border-b">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-semibold text-gray-800">{% trans "Menu" %}</h2>
                    <button id="close-sidebar" class="text-gray-500 hover:text-gray-700">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto">
                <div class="px-4 py-2 space-y-1">
                    <a href="{% url "home" %}" class="flex items-center px-4 py-3 {% if request.resolver_match.url_name == 'home' %}text-white bg-primary{% else %}text-gray-700 hover:bg-gray-100{% endif %} rounded-lg">
                        <i data-lucide="home" class="w-5 h-5"></i>
                        <span class="ml-3">{% trans "Home" %}</span>
                    </a>
                    <a href="{% url "leaderboard" %}" class="flex items-center px-4 py-3 {% if request.resolver_match.url_name == 'leaderboard' %}text-white bg-primary{% else %}text-gray-700 hover:bg-gray-100{% endif %} rounded-lg">
                        <i data-lucide="trophy" class="w-5 h-5"></i>
                        <span class="ml-3">{% trans "Leaderboard" %}</span>
                    </a>
                    {% if user.is_superuser %}
                            <a href="{% url "appointments" %}" class="flex items-center px-4 py-3 {% if request.resolver_match.url_name == 'appointments' %}text-white bg-primary{% else %}text-gray-700 hover:bg-gray-100{% endif %} rounded-lg">
                                <i data-lucide="calendar" class="w-5 h-5"></i>
                                <span class="ml-3">{% trans "Appointments" %}</span>
                            </a>
                            <a href="{% url "register_driver" %}" class="flex items-center px-4 py-3 {% if request.resolver_match.url_name == 'register_driver' %}text-white bg-primary{% else %}text-gray-700 hover:bg-gray-100{% endif %} rounded-lg">
                                <i data-lucide="user-round-plus" class="w-5 h-5"></i>
                                <span class="ml-3">{% trans "Add New Driver" %}</span>
                            </a>
                            <a href="{% url 'driver_list' %}" class="flex items-center px-4 py-3 {% if request.resolver_match.url_name == 'driver_list' %}text-white bg-primary{% else %}text-gray-700 hover:bg-gray-100{% endif %} rounded-lg">
                                <i data-lucide="users" class="w-5 h-5"></i>
                                <span class="ml-3">{% trans "Driver List" %}</span>
                            </a>
                        {% elif user.is_driver %}
                            <a href="{% url "appointments" %}" class="flex items-center px-4 py-3 {% if request.resolver_match.url_name == 'appointments' %}text-white bg-primary{% else %}text-gray-700 hover:bg-gray-100{% endif %} rounded-lg">
                                <i data-lucide="calendar" class="w-5 h-5"></i>
                                <span class="ml-3">{% trans "Book Appointment" %}</span>
                            </a>
                            <a href="{% url "my_rides" %}" class="flex items-center px-4 py-3 {% if request.resolver_match.url_name == 'my_rides' %}text-white bg-primary{% else %}text-gray-700 hover:bg-gray-100{% endif %} rounded-lg">
                                <i data-lucide="calendar" class="w-5 h-5"></i>
                                <span class="ml-3">{% trans "Rides" %}</span>
                            </a>
                        {% else %}
                            <a href="{% url "my_rides" %}" class="flex items-center px-4 py-3 {% if request.resolver_match.url_name == 'my_rides' %}text-white bg-primary{% else %}text-gray-700 hover:bg-gray-100{% endif %} rounded-lg">
                                <i data-lucide="car-taxi-front" class="w-5 h-5"></i>
                                <span class="ml-3">{% trans "Book Ride" %}</span>
                            </a>   
                            <a href="{% url "appointments" %}" class="flex items-center px-4 py-3 {% if request.resolver_match.url_name == 'appointments' %}text-white bg-primary{% else %}text-gray-700 hover:bg-gray-100{% endif %} rounded-lg">
                                <i data-lucide="user-round-plus" class="w-5 h-5"></i>
                                <span class="ml-3">{% trans "Upgrade to Driver" %}</span>
                            </a>
                        {% endif %}
                </div>
            </div>
            <div class="p-4 border-t">
                <div class="flex items-center space-x-3 px-4 py-3">
                    <i data-lucide="mail" class="w-5 h-5 text-gray-400"></i>
                    <span class="text-sm text-gray-600">{{ user.email }}</span>
                </div>
                <a href="{% url 'account_logout' %}" class="flex items-center px-4 py-3 text-red-600 rounded-lg hover:bg-red-100">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                    <span class="ml-3">{% trans "Logout" %}</span>
                </a>
            </div>
            <div class="h-20"></div>
        </nav>
    </div>

    <div class="flex flex-1 overflow-hidden">
        <!-- Desktop Sidebar (hidden on mobile) -->
        <div class="hidden lg:flex lg:flex-shrink-0">
            <div class="w-64 bg-white shadow-lg">
                <div class="p-6">
                    <h2 class="text-xl font-semibold text-gray-800">{% trans "Dashboard" %}</h2>
                </div>
                <nav class="mt-6">
                    <div class="px-4 space-y-2">
                        <!-- Same navigation items as mobile menu -->
                        <a href="{% url "home" %}" class="flex items-center px-4 py-3 {% if request.resolver_match.url_name == 'home' %}text-white bg-primary{% else %}text-gray-700 hover:bg-gray-100{% endif %} rounded-lg">
                            <i data-lucide="home" class="w-5 h-5"></i>
                            <span class="ml-3">{% trans "Home" %}</span>
                        </a>
                        <a href="{% url "leaderboard" %}" class="flex items-center px-4 py-3 {% if request.resolver_match.url_name == 'leaderboard' %}text-white bg-primary{% else %}text-gray-700 hover:bg-gray-100{% endif %} rounded-lg">
                            <i data-lucide="trophy" class="w-5 h-5"></i>
                            <span class="ml-3">{% trans "Leaderboard" %}</span>
                        </a>
                        {% comment %} <a href="{% url "ratings" %}" class="flex items-center px-4 py-3 {% if request.resolver_match.url_name == 'ratings' %}text-white bg-primary{% else %}text-gray-700 hover:bg-gray-100{% endif %} rounded-lg">
                            <i data-lucide="star" class="w-5 h-5"></i>
                            <span class="ml-3">{% trans "Ratings" %}</span>
                        </a> {% endcomment %}
                        {% if user.is_superuser %}
                            <a href="{% url 'admin_dashboard' %}" class="flex items-center px-4 py-3 {% if request.resolver_match.url_name == 'admin_dashboard' %}text-white bg-primary{% else %}text-gray-700 hover:bg-gray-100{% endif %} rounded-lg">
                                <i data-lucide="bar-chart-2" class="w-5 h-5"></i>
                                <span class="ml-3">{% trans "Dashboard" %}</span>
                            </a>
                            <a href="{% url "appointments" %}" class="flex items-center px-4 py-3 {% if request.resolver_match.url_name == 'appointments' %}text-white bg-primary{% else %}text-gray-700 hover:bg-gray-100{% endif %} rounded-lg">
                                <i data-lucide="calendar" class="w-5 h-5"></i>
                                <span class="ml-3">{% trans "Appointments" %}</span>
                            </a>
                            <a href="{% url "register_driver" %}" class="flex items-center px-4 py-3 {% if request.resolver_match.url_name == 'register_driver' %}text-white bg-primary{% else %}text-gray-700 hover:bg-gray-100{% endif %} rounded-lg">
                                <i data-lucide="user-round-plus" class="w-5 h-5"></i>
                                <span class="ml-3">{% trans "Add New Driver" %}</span>
                            </a>
                            <a href="{% url 'driver_list' %}" class="flex items-center px-4 py-3 {% if request.resolver_match.url_name == 'driver_list' %}text-white bg-primary{% else %}text-gray-700 hover:bg-gray-100{% endif %} rounded-lg">
                                <i data-lucide="users" class="w-5 h-5"></i>
                                <span class="ml-3">{% trans "Driver List" %}</span>
                            </a>
                        {% elif user.is_driver %}
                            <a href="{% url "appointments" %}" class="flex items-center px-4 py-3 {% if request.resolver_match.url_name == 'appointments' %}text-white bg-primary{% else %}text-gray-700 hover:bg-gray-100{% endif %} rounded-lg">
                                <i data-lucide="calendar" class="w-5 h-5"></i>
                                <span class="ml-3">{% trans "Book Appointment" %}</span>
                            </a>
                            <a href="{% url "my_rides" %}" class="flex items-center px-4 py-3 {% if request.resolver_match.url_name == 'my_rides' %}text-white bg-primary{% else %}text-gray-700 hover:bg-gray-100{% endif %} rounded-lg">
                                <i data-lucide="calendar" class="w-5 h-5"></i>
                                <span class="ml-3">{% trans "Rides" %}</span>
                            </a>
                        {% else %}
                            <a href="{% url "my_rides" %}" class="flex items-center px-4 py-3 {% if request.resolver_match.url_name == 'my_rides' %}text-white bg-primary{% else %}text-gray-700 hover:bg-gray-100{% endif %} rounded-lg">
                                <i data-lucide="car-taxi-front" class="w-5 h-5"></i>
                                <span class="ml-3">{% trans "Book A Ride" %}</span>
                            </a>
                            <a href="{% url "appointments" %}" class="flex items-center px-4 py-3 {% if request.resolver_match.url_name == 'appointments' %}text-white bg-primary{% else %}text-gray-700 hover:bg-gray-100{% endif %} rounded-lg">
                                <i data-lucide="user-round-pen" class="w-5 h-5"></i>
                                <span class="ml-3">{% trans "Upgrade to Driver" %}</span>
                            </a>
                        {% endif %}
                    </div>
                    <div class="px-8 mt-8">
                        <hr class="border-gray-200">
                    </div>
                    
                    <div class="px-4 mt-8">
                        <a href="{% url 'account_set_password' %}" class="flex items-center px-4 py-3 text-blue-600 hover:bg-blue-100 rounded-lg">
                            <i data-lucide="key" class="w-5 h-5"></i>
                            <span class="ml-3">{% trans "Change Password" %}</span>
                        </a>
                    </div>
                    <div class="px-4 mt-2">
                        <a href="{% url 'account_logout' %}" class="flex items-center px-4 py-3 text-red-600 hover:bg-red-100 rounded-lg">
                            <i data-lucide="log-out" class="w-5 h-5"></i>
                            <span class="ml-3">{% trans "Logout" %}</span>
                        </a>
                    </div>
                </nav>
            </div>
        </div>
        <!-- Main Content -->
        <div class="flex-1 overflow-auto">
            <!-- Desktop Header (hidden on mobile) -->
            <header class="hidden lg:block bg-white shadow-sm">
                <div class="flex items-center justify-between px-8 py-4">
                    <!-- Welcome Message Based on Role -->
                    <div class="mb-8">
                        {% if user.is_superuser %}
                            <h1 class="text-2xl font-medium">{% trans "Welcome, Manager!" %}</h1>
                            <p class="text-gray-600">{% trans "You have full access to manage the system." %}</p>
                        {% elif user.is_driver %}
                            <h1 class="text-2xl font-medium">{% trans "Welcome, Driver!" %}</h1>
                            <p class="text-gray-600">{% trans "Manage your rides and appointments here." %}</p>
                        {% else %}
                            <h1 class="text-2xl font-medium">{% trans "Welcome, Passenger!" %}</h1>
                            <p class="text-gray-600">{% trans "Book rides and view your history here." %}</p>
                        {% endif %}
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-gray-600">{{ user.email }}</span>
                    </div>
                </div>
            </header>
            {% block dashboard_content %}{% endblock dashboard_content %}
        </div>
    </div>
</div>

<!-- Mobile Bottom Navigation (Only visible on mobile) -->
<header class="lg:hidden grid grid-cols-4 px-4 py-2 fixed w-screen bottom-0 left-0 z-50 bg-white">
    {% if user.is_superuser %}
        <a href="{% url 'leaderboard' %}" class="pb-2 pt-4 flex flex-col items-center justify-center px-4 rounded-xl {% if request.resolver_match.url_name == 'leaderboard' %}text-primary bg-gray-100{% else %}text-gray-600{% endif %}">
            <i data-lucide="trophy" class="w-6 h-6"></i>
            <span class="text-sm mt-1">{% trans "Rankings" %}</span>
        </a>
        <a href="{% url 'admin_dashboard' %}" class="pb-2 pt-4 flex flex-col items-center justify-center px-4 rounded-xl {% if request.resolver_match.url_name == 'admin_dashboard' %}text-primary bg-gray-100{% else %}text-gray-600{% endif %}">
            <i data-lucide="bar-chart-2" class="w-6 h-6"></i>
            <span class="text-sm mt-1">{% trans "Dashboard" %}</span>
        </a>
        <a href="{% url 'appointments' %}" class="pb-2 pt-4 flex flex-col items-center justify-center px-4 rounded-xl {% if request.resolver_match.url_name == 'appointments' %}text-primary bg-gray-100{% else %}text-gray-600{% endif %}">
            <i data-lucide="calendar" class="w-6 h-6"></i>
            <span class="text-sm mt-1">{% trans "Appointments" %}</span>
        </a>
        <a href="{% url 'driver_list' %}" class="pb-2 pt-4 flex flex-col items-center justify-center px-4 rounded-xl {% if request.resolver_match.url_name == 'driver_list' %}text-primary bg-gray-100{% else %}text-gray-600{% endif %}">
            <i data-lucide="users" class="w-6 h-6"></i>
            <span class="text-sm mt-1">{% trans "Drivers" %}</span>
        </a>
    {% elif user.is_driver %}
        <a href="{% url 'leaderboard' %}" class="pb-2 pt-4 flex flex-col items-center justify-center px-4 rounded-xl {% if request.resolver_match.url_name == 'leaderboard' %}text-primary bg-gray-100{% else %}text-gray-600{% endif %}">
            <i data-lucide="trophy" class="w-6 h-6"></i>
            <span class="text-sm mt-1">{% trans "Rankings" %}</span>
        </a>   
        <a href="{% url 'appointments' %}" class="pb-2 pt-4 flex flex-col items-center justify-center px-4 rounded-xl {% if request.resolver_match.url_name == 'appointments' %}text-primary bg-gray-100{% else %}text-gray-600{% endif %}">
            <i data-lucide="calendar" class="w-6 h-6"></i>
            <span class="text-sm mt-1">{% trans "Appointments" %}</span>
        </a>
        <a href="{% url 'home' %}" class="pb-2 pt-4 flex flex-col items-center justify-center px-4 py-4 rounded-xl {% if request.resolver_match.url_name == 'home' %}text-primary bg-gray-100{% else %}text-gray-600{% endif %}">
            <i data-lucide="home" class="w-6 h-6"></i>
            <span class="text-sm mt-1">{% trans "Home" %}</span>
        </a> 
        <a href="{% url 'my_rides' %}" class="pb-2 pt-4 flex flex-col items-center justify-center rounded-xl {% if request.resolver_match.url_name == 'my_rides' %}text-primary bg-gray-100{% else %}text-gray-600{% endif %}">
            <i data-lucide="car-taxi-front" class="w-6 h-6"></i>
            <span class="text-sm mt-1">{% trans "Rides" %}</span>
        </a>
    {% else %}
        <a href="{% url 'my_rides' %}" class="pb-2 pt-4 flex flex-col items-center justify-center rounded-xl {% if request.resolver_match.url_name == 'my_rides' %}text-primary bg-gray-100{% else %}text-gray-600{% endif %}">
            <i data-lucide="history" class="w-6 h-6"></i>
            <span class="text-md mt-1">{% trans "History" %}</span>
        </a>
        <a href="{% url 'leaderboard' %}" class="pb-2 pt-4 flex flex-col items-center justify-center rounded-xl {% if request.resolver_match.url_name == 'leaderboard' %}text-primary bg-gray-100{% else %}text-gray-600{% endif %}">
            <i data-lucide="trophy" class="w-6 h-6"></i>
            <span class="text-md mt-1">{% trans "Rankings" %}</span>
        </a>
        <a href="{% url 'home' %}" class="pb-2 pt-4 flex flex-col items-center justify-center rounded-xl {% if request.resolver_match.url_name == 'home' %}text-primary bg-gray-100{% else %}text-gray-600{% endif %}">
            <i data-lucide="home" class="w-6 h-6"></i>
            <span class="text-md mt-1">{% trans "Home" %}</span>
        </a>
        <a href="{% url 'request_ride' %}" class="pb-2 pt-4 flex flex-col items-center justify-center rounded-xl {% if request.resolver_match.url_name == 'request_ride' %}text-primary bg-gray-100{% else %}text-gray-600{% endif %}">
            <i data-lucide="car-taxi-front" class="w-6 h-6"></i>
            <span class="text-md mt-1">{% trans "Book Ride" %}</span>
        </a>
    {% endif %}
</header>

<div id="alert-container" class="fixed top-4 right-4 space-y-4 z-50 w-72"></div>

<script>
    // Mobile menu functionality (previous sidebar code)
    const mobileMenuButton = document.getElementById('mobile-menu-button');
    const closeSidebarButton = document.getElementById('close-sidebar');
    const mobileSidebar = document.getElementById('mobile-sidebar');
    const sidebarOverlay = mobileSidebar.querySelector('.bg-gray-600');
    const sidebarContent = mobileSidebar.querySelector('nav');

    function openSidebar() {
        mobileSidebar.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeSidebar() {
        mobileSidebar.classList.add('hidden');
        document.body.style.overflow = '';
    }

    mobileMenuButton.addEventListener('click', openSidebar);
    closeSidebarButton.addEventListener('click', closeSidebar);
    
    mobileSidebar.addEventListener('click', (e) => {
        if (!sidebarContent.contains(e.target)) {
            closeSidebar();
        }
    });

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !mobileSidebar.classList.contains('hidden')) {
            closeSidebar();
        }
    });

    sidebarContent.addEventListener('click', (e) => {
        e.stopPropagation();
    });

    // New Profile Dialog functionality
    const mobileProfileButton = document.getElementById('mobile-profile-button');
    const profileDialog = document.getElementById('mobile-profile-dialog');
    const closeProfileButton = document.getElementById('close-profile-dialog');

    function openProfileDialog() {
        profileDialog.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeProfileDialog() {
        profileDialog.classList.add('hidden');
        document.body.style.overflow = '';
    }

    mobileProfileButton.addEventListener('click', openProfileDialog);
    closeProfileButton.addEventListener('click', closeProfileDialog);

    // Close profile dialog when clicking outside
    profileDialog.addEventListener('click', (e) => {
        const dialogContent = profileDialog.querySelector('.bg-white');
        if (!dialogContent.contains(e.target)) {
            closeProfileDialog();
        }
    });

    // Close profile dialog on escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !profileDialog.classList.contains('hidden')) {
            closeProfileDialog();
        }
    });

    // --- SSE Alert Handling ---
    document.addEventListener('DOMContentLoaded', function() {
        const alertContainer = document.getElementById('alert-container');
        let eventSource = null; // Track SSE connection

        // Get active ride ID from context (provided by context processor)
        const activeRideId = "{{ active_ride_id }}"; // Will be empty if no active ride

        // Function to display individual alert notifications
        function addAlertNotification(alertData) {
            if (!alertContainer) return;

            const alertDiv = document.createElement('div');
                // Make alerts clickable/interactive again
            alertDiv.classList.add('pointer-events-auto');
            // Using Tailwind classes for styling
            alertDiv.className += `
                animate__animated animate__fadeInRight
                p-4 mb-3 rounded-xl border-l-4 shadow-lg
                ${alertData.alert_level === 'HIGH' ?
                'bg-red-50 border-red-500 text-red-800' :
                'bg-yellow-50 border-yellow-500 text-yellow-800'
                }
            `; // Assuming you only show HIGH/MEDIUM notifications
            alertDiv.innerHTML = `
                <div class="flex items-center">
                        <svg class="w-5 h-5 mr-2 ${alertData.alert_level === 'HIGH' ? 'text-red-500' : 'text-yellow-500'}"
                        fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    <h3 class="font-bold">${alertData.alert_level} Alert</h3>
                </div>
                <p class="mt-1 text-md">Drowsiness Score: <span class="font-mono">${alertData.drowsiness_score.toFixed(2)}</span></p>
                <p class="text-md opacity-75 mt-2">${new Date(alertData.timestamp).toLocaleString()}</p>
            `;
            alertContainer.prepend(alertDiv);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                alertDiv.classList.remove('animate__fadeInRight');
                alertDiv.classList.add('animate__fadeOutRight');
                setTimeout(() => alertDiv.remove(), 500);
            }, 10000);
        }

        // Function to update alert counts (ONLY if elements exist)
        function updateAlertCounts(counts) {
            const highAlertsSpan = document.getElementById('high-alerts-count');
            const mediumAlertsSpan = document.getElementById('medium-alerts-count');
            const lowAlertsSpan = document.getElementById('low-alerts-count');

            // Only update if the elements are found on the current page
            if (highAlertsSpan) highAlertsSpan.textContent = counts.high;
            if (mediumAlertsSpan) mediumAlertsSpan.textContent = counts.medium;
            if (lowAlertsSpan) lowAlertsSpan.textContent = counts.low;
        }

        // Setup SSE connection if an active ride exists for the user
        function setupSSE() {
            if (activeRideId) { // Check if context processor provided an ID
                    if (eventSource) {
                    eventSource.close(); // Close existing connection if any
                    }

                console.log(`Connecting to SSE for ride ID: ${activeRideId}`); // Debugging
                eventSource = new EventSource(`/sse/drowsiness-alerts/${activeRideId}/`);

                eventSource.onmessage = function(event) {
                    if (event.data.trim() === '') return; // Skip keep-alive

                    try {
                        const data = JSON.parse(event.data);

                        // Process based on message type
                        if (data.type === 'alert') {
                            addAlertNotification(data);
                        } else if (data.type === 'counts') {
                            // Conditionally update counts only if elements exist
                            updateAlertCounts(data);
                        }
                    } catch (error) {
                        console.error('Error parsing SSE data:', error, event.data);
                    }
                };

                eventSource.onerror = function(error) {
                    console.error('SSE error:', error);
                    if (eventSource) {
                        eventSource.close(); // Close on error
                        eventSource = null; // Reset variable
                    }
                    // Optional: Maybe try reconnecting after a delay
                    // setTimeout(setupSSE, 5000); // Example: Retry after 5 seconds
                };

            } else {
                    console.log("No active ride found, SSE not connecting."); // Debugging
                    if (eventSource) {
                    eventSource.close(); // Ensure closed if ride becomes inactive
                    eventSource = null;
                    }
            }
        }

        // Initialize
        setupSSE();

        // Cleanup on page leave
        window.addEventListener('beforeunload', function() {
            if (eventSource) {
                eventSource.close();
            }
        });
    });
</script>
{% endblock content %}